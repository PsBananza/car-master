<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <title>Карточки организаций</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        .back-button {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: red;
            color: white;
            font-size: 14px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        .back-button:hover {
            background-color: darkred;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 20px;
            -webkit-text-size-adjust: 100%;
        }

        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
        }

        .organization-phone {
            font-size: 14px;
            margin-bottom: 8px;
            color: #555;
        }

        .container {
            max-width: 800px;
            margin: 50px auto 20px;
            width: 100%;
        }

        .organization-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .organization-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            padding: 15px;
        }

        .organization-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            gap: 10px;
        }

        .organization-status {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-moderation {
            background-color: #f8d7da;
            color: #721c24;
        }

        .edit-button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }

        .subcategory-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .subcategory-control-btn {
            flex: 1;
            padding: 5px 8px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
        }

        .subcategory-control-btn:hover {
            background-color: #5a6268;
        }

        .subcategory-select {
            width: 100%;
            padding: 8px;
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .edit-button:hover {
            background-color: #0069d9;
        }

        .images-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 15px;
        }

        .image-wrapper {
            width: calc(20% - 4px);
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 4px;
            background-color: #eee;
            position: relative;
        }

        .remove-image-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background-color: rgba(255,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            cursor: pointer;
            display: none;
        }

        .image-wrapper:hover .remove-image-btn {
            display: block;
        }

        .organization-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .organization-image:hover {
            transform: scale(1.03);
        }

        .organization-company {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .organization-address {
            font-size: 14px;
            margin-bottom: 8px;
            color: #555;
            cursor: default;
        }

        .organization-description {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            line-height: 1.5;
        }

        .categories-container {
            margin-top: 10px;
        }

        .categories-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .category-block {
            margin-bottom: 8px;
        }

        .category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 3px 0;
        }

        .category-name {
            font-weight: bold;
            margin-left: 5px;
        }

        .toggle-icon {
            width: 20px;
            text-align: center;
            transition: transform 0.2s;
            font-size: 14px;
        }

        .subcategories-container {
            margin-left: 25px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .subcategories-container.expanded {
            max-height: 300px;
            overflow-y: auto;
        }

        .subcategories-list {
            list-style-type: none;
            padding-left: 0;
            margin: 5px 0;
        }

        .subcategory-item {
            margin: 3px 0;
            color: #555;
            padding: 2px 0;
            font-size: 13px;
            word-break: break-word;
        }

        .show-more {
            color: #0066cc;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
            display: inline-block;
            background: none;
            border: none;
            padding: 0;
            text-decoration: underline;
        }

        .show-more:hover {
            text-decoration: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 90%;
            max-height: 80%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            cursor: pointer;
        }

        .edit-modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .form-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .save-btn {
            background-color: #28a745;
            color: white;
            border: none;
        }

        .save-btn:hover {
            background-color: #218838;
        }

        .cancel-btn {
            background-color: #6c757d;
            color: white;
            border: none;
        }

        .cancel-btn:hover {
            background-color: #5a6268;
        }

        .upload-area {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-top: 10px;
        }

        .upload-area:hover {
            border-color: #007bff;
        }

        /* Стили для выбора категорий */
        .categories-selector {
            margin-top: 10px;
        }

        .selected-categories {
            margin-top: 10px;
        }

        .selected-category button {
            background: none;
            border: none;
            color: #dc3545;
            margin-left: 5px;
            cursor: pointer;
        }

        .category-select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        .subcategory-select {
            width: 100%;
            padding: 8px;
            min-height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #subcategory-controls {
            margin-bottom: 10px;
        }

        #select-all-subcategories {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        #select-all-subcategories:hover {
            background-color: #5a6268;
        }

        .add-category-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-category-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .subcategories-container::-webkit-scrollbar {
            width: 6px;
        }

        .subcategories-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .subcategories-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .subcategories-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .card-actions {
            display: flex;
            gap: 5px;
        }

        .delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        .delete-modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .delete-confirm-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
        }

        .delete-confirm-btn:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
<button onclick="goBack()" class="back-button">⬅ Назад</button>
<div class="container">
    <ul id="organization-list" class="organization-list">
        <div class="loading-spinner"></div>
    </ul>
</div>

<!-- Модальное окно просмотра изображения -->
<div id="image-modal" class="modal">
    <span class="close" onclick="closeModal('image-modal')">&times;</span>
    <img id="modal-image" class="modal-content" alt="Фото">
</div>


<!-- Модальное окно редактирования -->
<div id="edit-modal" class="modal">
    <div class="edit-modal-content">
        <span class="close" onclick="closeModal('edit-modal')">&times;</span>
        <h2>Редактирование карточки</h2>
        <form id="edit-form" class="edit-form">
            <input type="hidden" id="edit-org-id">

            <div class="form-group">
                <label for="edit-company">Название компании *</label>
                <input type="text" id="edit-company" required>
                <div id="edit-company-error" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="edit-phone">Телефон *</label>
                <input type="tel" id="edit-phone" placeholder="+7 XXX XXX XX XX" required>
                <div id="edit-phone-error" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="edit-district">Область/Край *</label>
                <select id="edit-district" required onchange="updateCities(this.value)">
                    <option value="">Выберите область/край</option>
                    <option value="Ростовская область">Ростовская область</option>
                    <option value="Краснодарский край">Краснодарский край</option>
                </select>
                <div id="edit-district-error" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="edit-city">Город *</label>
                <select id="edit-city" required disabled>
                    <option value="">Сначала выберите область/край</option>
                </select>
                <div id="edit-city-error" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="edit-address">Адрес *</label>
                <input type="text" id="edit-address" required>
                <div id="edit-address-error" class="error-message"></div>
            </div>

            <div class="form-group">
                <label for="edit-description">Описание * (максимум 300 символов)</label>
                <textarea id="edit-description" maxlength="300" required></textarea>
                <div class="description-counter"><span id="description-counter">0</span>/300</div>
                <div id="edit-description-error" class="error-message"></div>
            </div>

            <div class="form-group">
                <label>Фотографии (максимум 5)</label>
                <div id="edit-images-container" class="images-container"></div>
                <div class="upload-area" id="upload-area">
                    Перетащите сюда файлы или кликните для загрузки
                    <input type="file" id="file-input" multiple accept="image/*" style="display: none;">
                </div>
            </div>

            <div class="form-group">
                <label>Статус</label>
                <div id="edit-status-display" class="organization-status"></div>
            </div>

            <div class="form-group">
                <label>Категории</label>
                <div class="categories-selector">
                    <select id="category-select" class="category-select">
                        <option value="">Выберите категорию</option>
                    </select>
                    <div id="subcategory-controls" style="display: none;">
                        <div class="subcategory-buttons">
                            <button type="button" id="select-all-subcategories" class="subcategory-control-btn">
                                Выбрать все
                            </button>
                            <button type="button" id="deselect-all-subcategories" class="subcategory-control-btn">
                                Снять все
                            </button>
                        </div>
                        <select id="subcategory-select" class="subcategory-select" multiple>
                            <option value="">Выберите подкатегории</option>
                        </select>
                    </div>

                    <button type="button" id="add-category-btn" class="add-category-btn" disabled>Добавить категорию</button>
                </div>
                <div class="selected-categories" id="selected-categories"></div>
            </div>

            <div class="form-actions">
                <button type="button" class="cancel-btn" onclick="closeModal('edit-modal')">Отмена</button>
                <button type="submit" class="save-btn">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div id="delete-modal" class="modal">
    <div class="delete-modal-content">
        <h3>Подтверждение удаления</h3>
        <p>Вы уверены, что хотите удалить эту карточку? Это действие нельзя отменить.</p>
        <div class="modal-actions">
            <button class="cancel-btn" onclick="closeModal('delete-modal')">Отмена</button>
            <button class="delete-confirm-btn" onclick="confirmDelete()">Удалить</button>
        </div>
    </div>
</div>

<script>
    let currentEditingOrg = null;
    let newImages = [];
    let imagesToDelete = [];
    let allCategories = {};
    let selectedCategories = {};

    // Список областей и городов
    const districtsCities = {
        "Ростовская область": [
            "Ростов-на-Дону", "Аксай", "Азов", "Батайск", "Волгодонск", "Гуково", "Зверево",
            "Каменск-Шахтинский", "Красносулинск", "Миллерово", "Морозовск", "Новочеркасск",
            "Новошахтинск", "Пролетарск", "Ремонтное", "Сальск", "Семикаракорск", "Шахты",
            "Таганрог", "Тимашевск", "Чертков", "Цимлянск", "Шолоховский"
        ],
        "Краснодарский край": [
            "Краснодар"
        ]
    };

    let cardToDeleteId = null;

    function openDeleteModal(cardId) {
        cardToDeleteId = cardId;
        document.getElementById('delete-modal').style.display = 'flex';
    }

    async function confirmDelete() {
        if (!cardToDeleteId) return;

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const telegramId = urlParams.get('telegramId') || localStorage.getItem('telegramId');

            const response = await fetch(`/card/remove?id=${cardToDeleteId}&telegramId=${telegramId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Карточка успешно удалена');
                closeModal('delete-modal');
                loadOrganizationCards(); // Перезагружаем список карточек
            } else {
                throw new Error('Ошибка при удалении');
            }
        } catch (error) {
            console.error('Ошибка:', error);
            alert('Не удалось удалить карточку: ' + error.message);
        } finally {
            cardToDeleteId = null;
        }
    }

    function goBack() {
        window.history.back();
    }

    function validatePhone(phone) {
        const cleaned = phone.replace(/\D/g, '');
        return cleaned.length === 11 && cleaned.startsWith('7');
    }

    function formatPhoneNumber(phone) {
        if (!phone) return '';
        const cleaned = phone.replace(/\D/g, '');
        const match = cleaned.match(/^(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})$/);
        if (match) {
            return `+${match[1]} ${match[2]} ${match[3]} ${match[4]}${match[5]}`;
        }
        return phone;
    }

    function validateForm() {
        let isValid = true;

        // Проверка названия компании
        const company = document.getElementById('edit-company').value.trim();
        if (!company) {
            document.getElementById('edit-company-error').textContent = 'Введите название компании';
            isValid = false;
        } else {
            document.getElementById('edit-company-error').textContent = '';
        }

        // Проверка телефона
        const phone = document.getElementById('edit-phone').value.trim();
        if (!phone) {
            document.getElementById('edit-phone-error').textContent = 'Введите номер телефона';
            isValid = false;
        } else if (!validatePhone(phone)) {
            document.getElementById('edit-phone-error').textContent = 'Телефон должен быть в формате +7 XXX XXX XX XX';
            isValid = false;
        } else {
            document.getElementById('edit-phone-error').textContent = '';
        }

        // Проверка области
        const district = document.getElementById('edit-district').value;
        if (!district) {
            document.getElementById('edit-district-error').textContent = 'Выберите область/край';
            isValid = false;
        } else {
            document.getElementById('edit-district-error').textContent = '';
        }

        // Проверка города
        const city = document.getElementById('edit-city').value;
        if (!city) {
            document.getElementById('edit-city-error').textContent = 'Выберите город';
            isValid = false;
        } else {
            document.getElementById('edit-city-error').textContent = '';
        }

        // Проверка адреса
        const address = document.getElementById('edit-address').value.trim();
        if (!address) {
            document.getElementById('edit-address-error').textContent = 'Введите адрес';
            isValid = false;
        } else {
            document.getElementById('edit-address-error').textContent = '';
        }

        // Проверка описания
        const description = document.getElementById('edit-description').value.trim();
        if (!description) {
            document.getElementById('edit-description-error').textContent = 'Введите описание';
            isValid = false;
        } else if (description.length > 300) {
            document.getElementById('edit-description-error').textContent = 'Описание не должно превышать 300 символов';
            isValid = false;
        } else {
            document.getElementById('edit-description-error').textContent = '';
        }

        return isValid;
    }

    function updateDescriptionCounter() {
        const description = document.getElementById('edit-description').value;
        document.getElementById('description-counter').textContent = description.length;
    }

    function formatCategories(categories) {
        if (!categories || !Array.isArray(categories) || categories.length === 0) {
            return '';
        }

        let html = '<div class="categories-container">';
        html += '<div class="categories-title">Категории:</div>';

        categories.forEach(category => {
            const hasSubcategories = category.subCategories && category.subCategories.length > 0;
            const showLimited = hasSubcategories && category.subCategories.length > 10;
            const visibleCount = showLimited ? 10 : category.subCategories?.length || 0;

            html += `
                <div class="category-block" data-category-id="${category.categoryId}">
                    <div class="category-header" onclick="toggleSubcategories(this)">
                        <span class="toggle-icon">${hasSubcategories ? '▸' : '•'}</span>
                        <span class="category-name">${category.name || 'Без названия'}</span>
                    </div>
                    ${hasSubcategories ? `
                    <div class="subcategories-container">
                        <ul class="subcategories-list">
                            ${category.subCategories.slice(0, visibleCount).map(subCat => `
                                <li class="subcategory-item">${subCat.name || 'Без названия'}</li>
                            `).join('')}
                        </ul>
                        ${showLimited ? `
                        <button class="show-more" onclick="showAllSubcategories(event, this)">
                            Показать все (${category.subCategories.length})
                        </button>
                        ` : ''}
                    </div>
                    ` : ''}
                </div>
            `;
        });

        html += '</div>';
        return html;
    }

    function toggleSubcategories(headerElement) {
        const icon = headerElement.querySelector('.toggle-icon');
        const container = headerElement.nextElementSibling;

        if (container && container.classList.contains('subcategories-container')) {
            container.classList.toggle('expanded');
            icon.textContent = container.classList.contains('expanded') ? '▾' : '▸';
        }
    }

    function showAllSubcategories(event, buttonElement) {
        event.stopPropagation();
        const container = buttonElement.parentElement;
        const list = container.querySelector('.subcategories-list');
        const categoryBlock = container.closest('.category-block');
        const categoryId = categoryBlock.dataset.categoryId;

        const orgItem = categoryBlock.closest('.organization-item');
        const orgData = orgItem._orgData;

        if (orgData?.categories) {
            const category = orgData.categories.find(cat => cat.categoryId === categoryId);
            if (category?.subCategories) {
                buttonElement.remove();

                const alreadyShown = list.querySelectorAll('.subcategory-item').length;
                const remainingSubcats = category.subCategories.slice(alreadyShown);

                const fragment = document.createDocumentFragment();
                remainingSubcats.forEach(subCat => {
                    const item = document.createElement('li');
                    item.className = 'subcategory-item';
                    item.textContent = subCat.name || 'Без названия';
                    fragment.appendChild(item);
                });

                list.appendChild(fragment);
                container.classList.add('expanded');
                const icon = categoryBlock.querySelector('.toggle-icon');
                if (icon) icon.textContent = '▾';
            }
        }
    }

    async function loadCategories() {
        try {
            const response = await fetch('/categories/subcategories');
            if (!response.ok) throw new Error('Ошибка загрузки категорий');
            const data = await response.json();
            allCategories = data;

            const categorySelect = document.getElementById('category-select');
            categorySelect.innerHTML = '<option value="">Выберите категорию</option>';

            Object.keys(data).forEach(categoryName => {
                const option = document.createElement('option');
                option.value = categoryName;
                option.textContent = categoryName;
                categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Ошибка загрузки категорий:', error);
        }
    }

    function updateSubcategorySelect(categoryName) {
        const subcategoryControls = document.getElementById('subcategory-controls');
        const subcategorySelect = document.getElementById('subcategory-select');
        subcategorySelect.innerHTML = '';

        if (categoryName && allCategories[categoryName] && allCategories[categoryName].length > 0) {
            subcategoryControls.style.display = 'block';

            allCategories[categoryName].forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory;
                option.textContent = subcategory;
                subcategorySelect.appendChild(option);
            });
        } else {
            subcategoryControls.style.display = 'none';
        }
    }

    function selectAllSubcategories() {
        const subcategorySelect = document.getElementById('subcategory-select');
        const options = subcategorySelect.options;

        for (let i = 0; i < options.length; i++) {
            options[i].selected = true;
        }
    }

    function deselectAllSubcategories() {
        const subcategorySelect = document.getElementById('subcategory-select');
        const options = subcategorySelect.options;

        for (let i = 0; i < options.length; i++) {
            options[i].selected = false;
        }
    }

    function addSelectedCategory() {
        const categorySelect = document.getElementById('category-select');
        const subcategorySelect = document.getElementById('subcategory-select');
        const categoryName = categorySelect.value;

        if (!categoryName) return;

        const selectedSubcategories = Array.from(subcategorySelect.selectedOptions)
            .map(option => option.value)
            .filter(Boolean);

        if (!selectedCategories[categoryName]) {
            selectedCategories[categoryName] = [];
        }

        selectedSubcategories.forEach(subcategory => {
            if (!selectedCategories[categoryName].includes(subcategory)) {
                selectedCategories[categoryName].push(subcategory);
            }
        });

        if (selectedSubcategories.length === 0 && subcategorySelect.style.display === 'none') {
            selectedCategories[categoryName] = [];
        }

        renderSelectedCategories();
    }

    function renderSelectedCategories() {
        const container = document.getElementById('selected-categories');
        container.innerHTML = '';

        Object.keys(selectedCategories).forEach(categoryName => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'selected-category';

            let subcatsText = '';
            if (selectedCategories[categoryName].length > 0) {
                const subcats = selectedCategories[categoryName];
                const displayCount = Math.min(3, subcats.length);
                subcatsText = `: ${subcats.slice(0, displayCount).join(', ')}`;
                if (subcats.length > displayCount) {
                    subcatsText += ` +${subcats.length - displayCount} more`;
                }
            }

            categoryDiv.innerHTML = `
                ${categoryName}${subcatsText}
                <button onclick="removeCategory('${categoryName}')">×</button>
            `;

            container.appendChild(categoryDiv);
        });
    }

    function removeCategory(categoryName) {
        delete selectedCategories[categoryName];
        renderSelectedCategories();
    }

    async function openEditModal(orgData) {
        currentEditingOrg = orgData;
        newImages = [];
        imagesToDelete = [];
        selectedCategories = {};

        if (orgData.categories) {
            orgData.categories.forEach(cat => {
                selectedCategories[cat.name] = cat.subCategories?.map(sc => sc.name) || [];
            });
        }

        document.getElementById('edit-org-id').value = orgData.id;
        document.getElementById('edit-company').value = orgData.company || '';
        document.getElementById('edit-phone').value = formatPhoneNumber(orgData.phone || '+7');
        document.getElementById('edit-district').value = orgData.district || '';
        document.getElementById('edit-address').value = orgData.address || '';
        document.getElementById('edit-description').value = orgData.description || '';
        updateDescriptionCounter();

        // Заполняем города в зависимости от выбранной области
        document.getElementById('edit-district').value = orgData.district || '';
        if (orgData.district) {
            await updateCities(orgData.district);
        }
        const citySelect = document.getElementById('edit-city');

        if (orgData.district) {
            citySelect.innerHTML = '<option value="">Выберите город</option>';
            const cities = districtsCities[orgData.district] || [];
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                if (orgData.city === city) {
                    option.selected = true;
                }
                citySelect.appendChild(option);
            });
            citySelect.disabled = false;
        }

        const statusDisplay = document.getElementById('edit-status-display');
        statusDisplay.textContent = orgData.isActive ? 'Активно' : 'Неактивно';
        statusDisplay.className = `organization-status ${orgData.isActive ? 'status-active' : 'status-moderation'}`;

        const imagesContainer = document.getElementById('edit-images-container');
        imagesContainer.innerHTML = '';

        if (orgData.files && orgData.files.length > 0) {
            const filesToShow = orgData.files.slice(0, 5);
            for (const file of filesToShow) {
                try {
                    const imageResponse = await fetch(`/files/${file.fileId}`);
                    if (imageResponse.ok) {
                        const blob = await imageResponse.blob();
                        const dataUrl = await blobToDataURL(blob);

                        const wrapper = document.createElement('div');
                        wrapper.className = 'image-wrapper';
                        wrapper.dataset.fileId = file.fileId;
                        wrapper.innerHTML = `
                        <img src="${dataUrl}" class="organization-image">
                        <button class="remove-image-btn" onclick="removeImage('${file.fileId}')">×</button>
                    `;
                        imagesContainer.appendChild(wrapper);
                    }
                } catch (error) {
                    console.error('Ошибка загрузки изображения:', error);
                }
            }
        }

        await loadCategories();
        renderSelectedCategories();
        document.getElementById('edit-modal').style.display = 'flex';
    }

    async function updateCities(district) {
        const citySelect = document.getElementById('edit-city');
        citySelect.innerHTML = '<option value="">Загрузка городов...</option>';
        citySelect.disabled = true;

        try {
            const response = await fetch(`/cities?district=${encodeURIComponent(district)}`);
            if (!response.ok) throw new Error('Ошибка загрузки городов');

            const data = await response.json();
            const cities = data.cities || [];

            citySelect.innerHTML = '<option value="">Выберите город</option>';
            cities.forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                citySelect.appendChild(option);
            });

            citySelect.disabled = false;

            if (currentEditingOrg && currentEditingOrg.district === district) {
                citySelect.value = currentEditingOrg.city || '';
            }
        } catch (error) {
            console.error('Ошибка загрузки городов:', error);
            citySelect.innerHTML = '<option value="">Ошибка загрузки городов</option>';
        }
    }

    function removeImage(fileId) {
        if (confirm('Удалить это изображение?')) {
            const wrapper = document.querySelector(`.image-wrapper[data-file-id="${fileId}"]`);
            if (wrapper) {
                wrapper.remove();
                if (!imagesToDelete.includes(fileId)) {
                    imagesToDelete.push(fileId);
                }
            }
        }
    }

    function setupFileUpload() {
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const imagesContainer = document.getElementById('edit-images-container');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#007bff';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#ddd';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
                fileInput.value = '';
            }
        });

        function handleFiles(files) {
            const currentImageCount = document.querySelectorAll('#edit-images-container .image-wrapper').length;
            const availableSlots = 5 - currentImageCount;

            if (availableSlots <= 0) {
                alert('Максимум 5 фотографий на карточку');
                return;
            }

            const filesToAdd = Array.from(files).slice(0, availableSlots);

            filesToAdd.forEach(file => {
                if (!file.type.match('image.*')) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'image-wrapper';
                    wrapper.innerHTML = `
                    <img src="${e.target.result}" class="organization-image">
                    <button class="remove-image-btn" onclick="this.parentElement.remove()">×</button>
                `;
                    imagesContainer.appendChild(wrapper);

                    newImages.push({
                        file: file,
                        preview: e.target.result
                    });
                };
                reader.readAsDataURL(file);
            });
        }
    }

    async function saveOrganization() {
        if (!validateForm()) {
            return;
        }

        const formData = new FormData();
        const textFields = {
            'id': document.getElementById('edit-org-id').value,
            'company': document.getElementById('edit-company').value.trim(),
            'phone': document.getElementById('edit-phone').value.trim(),
            'district': document.getElementById('edit-district').value,
            'city': document.getElementById('edit-city').value,
            'address': document.getElementById('edit-address').value.trim(),
            'description': document.getElementById('edit-description').value.trim()
        };

        Object.entries(textFields).forEach(([key, value]) => {
            formData.append(key, new Blob([value], { type: 'text/plain' }));
        });

        const categories = Object.keys(selectedCategories).map(categoryName => ({
            name: categoryName,
            subCategories: selectedCategories[categoryName].map(name => ({ name }))
        }));
        formData.append('categories', new Blob([JSON.stringify(categories)], {
            type: 'application/json'
        }));

        if (imagesToDelete && imagesToDelete.length > 0) {
            formData.append('filesToDelete', new Blob(
                [JSON.stringify(imagesToDelete)],
                { type: 'application/json' }
            ));
        }

        if (newImages && newImages.length > 0) {
            newImages.forEach(img => {
                if (img.file) {
                    formData.append('newFiles', img.file);
                }
            });
        }

        try {
            const response = await fetch('/card/update', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'Ошибка сохранения (статус: ' + response.status + ')');
            }

            const result = await response.json();

            if (result.success) {
                alert('Изменения успешно сохранены');
                closeModal('edit-modal');
                loadOrganizationCards();
            } else {
                throw new Error(result.message || 'Неизвестная ошибка сервера');
            }

        } catch (error) {
            console.error('Ошибка при сохранении:', error);
            alert('Ошибка при сохранении: ' + error.message);
        }
    }

    async function loadOrganizationCards() {
        const list = document.getElementById('organization-list');
        list.innerHTML = '<div class="loading-spinner"></div>';

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const telegramId = urlParams.get('telegramId') || localStorage.getItem('telegramId');

            if (!telegramId) throw new Error('Telegram ID не указан');

            const response = await fetch('/card/info', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telegramId: telegramId })
            });

            if (!response.ok) throw new Error('Ошибка сервера');

            const organizations = await response.json();

            for (const org of organizations) {
                if (org.files && org.files.length > 0) {
                    for (const file of org.files) {
                        const imageResponse = await fetch(`/files/${file.fileId}`);
                        if (imageResponse.ok) {
                            const blob = await imageResponse.blob();
                            file.dataUrl = await blobToDataURL(blob);
                        }
                    }
                }
            }

            renderOrganizations(organizations);
        } catch (error) {
            console.error('Ошибка загрузки:', error);
            list.innerHTML = '<li>Ошибка загрузки данных. Пожалуйста, попробуйте позже.</li>';
        }
    }

    function blobToDataURL(blob) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(blob);
        });
    }

    function renderOrganizations(organizations) {
        const list = document.getElementById('organization-list');
        list.innerHTML = '';

        if (!Array.isArray(organizations) || organizations.length === 0) {
            list.innerHTML = '<li>Информация об организациях не найдена</li>';
            return;
        }

        organizations.forEach(org => {
            const li = document.createElement('li');
            li.className = 'organization-item';
            li._orgData = org;

            const statusText = org.isActive ? 'Активно' : 'Неактивно';
            const statusClass = org.isActive ? 'status-active' : 'status-moderation';

            const headerHtml = `
                <div class="organization-header">
                    <div class="organization-status ${statusClass}">${statusText}</div>
                    <div class="card-actions">
                        <button class="edit-button" onclick="openEditModal(${JSON.stringify(org).replace(/"/g, '&quot;')})">
                            ✏️ Редактировать
                        </button>
                        <button class="delete-button" onclick="openDeleteModal('${org.id}')">
                            🗑️ Удалить
                        </button>
                    </div>
                </div>
            `;

            const imagesToShow = org.files || [];
            let imagesHtml = '';

            if (imagesToShow.length > 0) {
                imagesHtml = '<div class="images-container">';
                imagesToShow.forEach((file) => {
                    if (file.dataUrl) {
                        imagesHtml += `
                            <div class="image-wrapper">
                                <img src="${file.dataUrl}"
                                     alt="Фото организации" class="organization-image"
                                     onclick="openModal('${file.dataUrl}')">
                            </div>
                        `;
                    }
                });
                imagesHtml += '</div>';
            }

            const phoneHtml = org.phone ? `☎ ${org.phone}` : 'Телефон не указан';

            const addressParts = [];
            if (org.district) addressParts.push(org.district);
            if (org.city) addressParts.push(org.city);
            if (org.address) addressParts.push(org.address);
            const addressHtml = addressParts.length > 0 ? `📍 ${addressParts.join(', ')}` : '';

            li.innerHTML = `
                ${headerHtml}
                ${imagesHtml}
                <div class="organization-info">
                    <div class="organization-company">${org.company || 'Компания не указана'}</div>
                    ${addressHtml ? `<div class="organization-address">${addressHtml}</div>` : ''}
                    <div class="organization-phone">${phoneHtml}</div>
                    ${org.description ? `<div class="organization-description">${org.description}</div>` : ''}
                    ${org.categories ? formatCategories(org.categories) : ''}
                </div>
            `;

            list.appendChild(li);
        });
    }

    function openModal(dataUrl) {
        const modalImg = document.getElementById('modal-image');
        modalImg.src = dataUrl;
        document.getElementById('image-modal').style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        if (modalId === 'delete-modal') {
            cardToDeleteId = null;
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        setupFileUpload();

        document.getElementById('edit-form').addEventListener('submit', (e) => {
            e.preventDefault();
            saveOrganization();
        });

        document.getElementById('delete-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal('delete-modal');
            }
        });

        document.getElementById('deselect-all-subcategories').addEventListener('click', deselectAllSubcategories);

        document.getElementById('select-all-subcategories').addEventListener('click', selectAllSubcategories);

        document.getElementById('category-select').addEventListener('change', function() {
            updateSubcategorySelect(this.value);
            document.getElementById('add-category-btn').disabled = !this.value;
        });

        document.getElementById('add-category-btn').addEventListener('click', addSelectedCategory);

        document.getElementById('deselect-all-subcategories').addEventListener('click', deselectAllSubcategories);

        loadOrganizationCards();
    });

    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
</script>
</body>
</html>