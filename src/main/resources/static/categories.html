<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Выбор категории</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .back-button {
            position: fixed;
            top: 10px;
            left: 10px;
            background-color: red;
            color: white;
            font-size: 14px;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
        }

        .back-button:hover {
            background-color: darkred;
        }

        .container {
            max-width: 800px;
            margin: 50px auto 20px;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #222;
            margin-bottom: 20px;
            text-align: center;
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .category-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            overflow: hidden;
            padding: 15px;
        }

        .category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .category-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .subcategories {
            margin-left: 28px;
            display: none;
        }

        .subcategory-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
        }

        .subcategory-checkbox {
            margin-right: 10px;
            width: 16px;
            height: 16px;
        }

        .select-all {
            font-weight: bold;
            margin: 10px 0;
            display: flex;
            align-items: center;
        }

        .continue-button {
            display: block;
            width: 100%;
            max-width: 200px;
            margin: 30px auto 0;
            padding: 12px;
            background-color: #00d0ff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
        }

        .continue-button:hover {
            background-color: #00a0cc;
        }
    </style>
</head>
<body>
<button class="back-button" onclick="history.back()">⬅ Назад</button>

<div class="container">
    <h1 class="page-title">Выбор категории</h1>
    <ul id="categoriesContainer" class="category-list"></ul>
    <button class="continue-button" onclick="continueRegistration()">Продолжить</button>
</div>

<script>
    function populateCategories(categories) {
        const container = document.getElementById("categoriesContainer");
        container.innerHTML = "";

        Object.keys(categories).forEach(category => {
            const li = document.createElement("li");
            li.className = "category-item";

            const categoryHeader = document.createElement("div");
            categoryHeader.className = "category-header";
            categoryHeader.innerHTML = `
                <input type="checkbox" class="category-checkbox" onchange="toggleSubcategories('${category}')">
                ${category}
            `;

            const subContainer = document.createElement("div");
            subContainer.id = `sub-${category}`;
            subContainer.className = "subcategories";

            if (categories[category].length > 0) {
                const selectAllDiv = document.createElement("div");
                selectAllDiv.className = "select-all";
                selectAllDiv.innerHTML = `
                    <input type="checkbox" class="subcategory-checkbox"
                           id="select-all-${category}"
                           onchange="toggleAllSubcategories('${category}')">
                    <label for="select-all-${category}">Выбрать все</label>
                `;
                subContainer.appendChild(selectAllDiv);

                categories[category].forEach(subcategory => {
                    const subItem = document.createElement("div");
                    subItem.className = "subcategory-item";
                    subItem.innerHTML = `
                        <input type="checkbox" class="subcategory-checkbox"
                               name="subcategories" value="${subcategory}"
                               data-category="${category}"
                               onchange="checkSelectAll('${category}')">
                        <label>${subcategory}</label>
                    `;
                    subContainer.appendChild(subItem);
                });
            } else {
                subContainer.style.display = "none";
            }

            li.appendChild(categoryHeader);
            li.appendChild(subContainer);
            container.appendChild(li);
        });
    }

    function toggleSubcategories(category) {
        const subContainer = document.getElementById(`sub-${category}`);
        const categoryCheckbox = document.querySelector(`.category-header input[onchange="toggleSubcategories('${category}')"]`);

        if (subContainer) {
            subContainer.style.display = categoryCheckbox.checked ? "block" : "none";
        }
    }

    function toggleAllSubcategories(category) {
        const selectAllCheckbox = document.getElementById(`select-all-${category}`);
        const subcategoryCheckboxes = document.querySelectorAll(`input[name='subcategories'][data-category='${category}']`);
        const categoryCheckbox = document.querySelector(`.category-header input[onchange="toggleSubcategories('${category}')"]`);

        subcategoryCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAllCheckbox.checked;
        });

        categoryCheckbox.checked = selectAllCheckbox.checked;
    }

    function checkSelectAll(category) {
        const subcategoryCheckboxes = document.querySelectorAll(`input[name='subcategories'][data-category='${category}']`);
        const selectAllCheckbox = document.getElementById(`select-all-${category}`);
        const categoryCheckbox = document.querySelector(`.category-header input[onchange="toggleSubcategories('${category}')"]`);

        selectAllCheckbox.checked = Array.from(subcategoryCheckboxes).every(checkbox => checkbox.checked);

        const isAnySubcategoryChecked = Array.from(subcategoryCheckboxes).some(checkbox => checkbox.checked);
        categoryCheckbox.checked = isAnySubcategoryChecked;
    }

    function continueRegistration() {
        const selectedCategories = {};

        document.querySelectorAll(".category-item").forEach(categoryItem => {
            const category = categoryItem.querySelector(".category-header").textContent.trim();
            const subContainer = categoryItem.querySelector(".subcategories");
            const categoryCheckbox = categoryItem.querySelector(".category-header input[type='checkbox']");

            if (subContainer) {
                const checkedSubcategories = Array.from(subContainer.querySelectorAll("input[name='subcategories']:checked"))
                    .map(checkbox => checkbox.value);

                if (checkedSubcategories.length > 0) {
                    selectedCategories[category] = checkedSubcategories;
                } else if (categoryCheckbox.checked) {
                    selectedCategories[category] = [];
                }
            } else {
                if (categoryCheckbox.checked) {
                    selectedCategories[category] = [];
                }
            }
        });

        if (Object.keys(selectedCategories).length === 0) {
            alert("Выберите хотя бы одну категорию или подкатегорию!");
            return;
        }

        localStorage.setItem("selectedCategories", JSON.stringify(selectedCategories));
        window.location.href = "upload_photos.html";
    }

    window.onload = function() {
        fetch("/categories/subcategories")
            .then(response => response.json())
            .then(data => populateCategories(data));
    };
</script>
</body>
</html>